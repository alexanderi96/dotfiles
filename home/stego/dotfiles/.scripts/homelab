#!/bin/bash

# Homelab Manager - Interactive SSH host management tool
# Reads from ~/.ssh/config and ~/.ssh/known_hosts

set -euo pipefail

# Configuration
SSH_CONFIG="${HOME}/.ssh/config"
KNOWN_HOSTS="${HOME}/.ssh/known_hosts"
STATUS_FILE="/tmp/homelab_status_$$"

# Cleanup on exit
trap "rm -f ${STATUS_FILE}* 2>/dev/null" EXIT

# Function to extract hosts from SSH config
get_ssh_hosts() {
    if [ ! -f "$SSH_CONFIG" ]; then
        return
    fi
    
    grep -i "^Host " "$SSH_CONFIG" 2>/dev/null | \
        awk '{print $2}' | \
        grep -v "\*" | \
        sort -u
}

# Function to get host details from SSH config
get_host_details() {
    local host=$1
    local hostname=""
    local user=""
    local port="22"
    
    if [ ! -f "$SSH_CONFIG" ]; then
        echo "$host|$host|$USER|22"
        return
    fi
    
    local in_host_block=0
    while IFS= read -r line; do
        if [[ $line =~ ^Host[[:space:]]+$host$ ]]; then
            in_host_block=1
            continue
        fi
        
        if [[ $in_host_block -eq 1 ]]; then
            if [[ $line =~ ^Host[[:space:]] ]]; then
                break
            fi
            
            if [[ $line =~ ^[[:space:]]*HostName[[:space:]]+(.+)$ ]]; then
                hostname="${BASH_REMATCH[1]}"
            elif [[ $line =~ ^[[:space:]]*User[[:space:]]+(.+)$ ]]; then
                user="${BASH_REMATCH[1]}"
            elif [[ $line =~ ^[[:space:]]*Port[[:space:]]+([0-9]+)$ ]]; then
                port="${BASH_REMATCH[1]}"
            fi
        fi
    done < "$SSH_CONFIG"
    
    [ -z "$hostname" ] && hostname="$host"
    [ -z "$user" ] && user="$USER"
    
    echo "$host|$hostname|$user|$port"
}

# Function to check host status asynchronously
check_host_status_async() {
    local hostname=$1
    local port=$2
    local idx=$3
    
    (
        if timeout 2 bash -c "cat < /dev/null > /dev/tcp/$hostname/$port" 2>/dev/null; then
            echo "online" > "${STATUS_FILE}_${idx}"
        else
            echo "offline" > "${STATUS_FILE}_${idx}"
        fi
    ) &
}

# Function to get status from file
get_status() {
    local idx=$1
    if [ -f "${STATUS_FILE}_${idx}" ]; then
        cat "${STATUS_FILE}_${idx}"
    else
        echo "checking"
    fi
}

# Function to display hosts
display_hosts() {
    local hosts=()
    mapfile -t hosts < <(get_ssh_hosts)
    
    if [ ${#hosts[@]} -eq 0 ]; then
        echo "No hosts found in $SSH_CONFIG"
        echo ""
        echo "Create hosts in $SSH_CONFIG with format:"
        echo "Host myserver"
        echo "    HostName 192.168.1.100"
        echo "    User admin"
        echo "    Port 22"
        return 1
    fi
    
    echo "=== Homelab Manager ==="
    echo ""
    echo "Host Status:"
    printf "%-4s %-20s %-25s %-15s %-10s\n" "No." "Host" "Hostname" "User" "Status"
    echo "--------------------------------------------------------------------------------"
    
    local idx=1
    for host in "${hosts[@]}"; do
        IFS='|' read -r name hostname user port <<< "$(get_host_details "$host")"
        local status=$(get_status "$idx")
        
        printf "%-4s %-20s %-25s %-15s %-10s\n" "$idx" "$name" "$hostname" "$user" "$status"
        
        # Start async check
        check_host_status_async "$hostname" "$port" "$idx"
        
        ((idx++))
    done
    
    echo ""
    return 0
}

# Function to display menu
show_menu() {
    local hosts=()
    mapfile -t hosts < <(get_ssh_hosts)
    
    echo "Actions:"
    echo "  1-${#hosts[@]})  Connect to host"
    echo "  c)  Copy SSH key to host"
    echo "  i)  Show host info"
    echo "  r)  Refresh status"
    echo "  q)  Quit"
    echo ""
}

# Function to connect to host
connect_host() {
    local host=$1
    echo "Connecting to $host..."
    ssh "$host"
}

# Function to copy SSH key to host
copy_key() {
    local host=$1
    local key_file="${HOME}/.ssh/id_ed25519.pub"
    
    if [ ! -f "$key_file" ]; then
        key_file="${HOME}/.ssh/id_rsa.pub"
    fi
    
    if [ ! -f "$key_file" ]; then
        echo "No SSH public key found!"
        echo "Generate one with: ssh-keygen -t ed25519"
        read -p "Press Enter to continue..."
        return
    fi
    
    echo "Copying SSH key to $host..."
    if ssh-copy-id "$host" 2>/dev/null; then
        echo "SSH key copied successfully!"
    else
        echo "Failed to copy SSH key"
    fi
    read -p "Press Enter to continue..."
}

# Function to show host info
show_host_info() {
    local host=$1
    IFS='|' read -r name hostname user port <<< "$(get_host_details "$host")"
    
    clear
    echo "=== Host Information: $name ==="
    echo ""
    echo "Hostname:  $hostname"
    echo "User:      $user"
    echo "Port:      $port"
    echo ""
    
    # Check status synchronously for info display
    if timeout 2 bash -c "cat < /dev/null > /dev/tcp/$hostname/$port" 2>/dev/null; then
        echo "Status:    online"
    else
        echo "Status:    offline"
    fi
    
    echo ""
    read -p "Press Enter to continue..."
}

# Main interactive loop
main() {
    while true; do
        clear
        
        # Clean old status files
        rm -f ${STATUS_FILE}_* 2>/dev/null
        
        if ! display_hosts; then
            read -p "Press Enter to exit..."
            exit 0
        fi
        
        # Wait a bit for async checks to complete
        sleep 0.5
        
        # Redisplay with updated status
        clear
        display_hosts >/dev/null  # Just to trigger status file creation
        
        # Wait for all background jobs
        wait
        
        # Final display with all statuses
        clear
        display_hosts
        
        show_menu
        
        # Read single keystroke without Enter
        read -n 1 -s choice
        echo ""  # New line after keystroke
        
        local hosts=()
        mapfile -t hosts < <(get_ssh_hosts)
        
        case $choice in
            [1-9]|[1-9][0-9])
                if [ "$choice" -le "${#hosts[@]}" ] && [ "$choice" -gt 0 ]; then
                    local selected_host="${hosts[$((choice-1))]}"
                    connect_host "$selected_host"
                else
                    echo "Invalid selection"
                    sleep 1
                fi
                ;;
            c|C)
                echo ""
                echo -n "Enter host number: "
                read -n 1 -s host_num
                echo ""
                if [ "$host_num" -le "${#hosts[@]}" ] && [ "$host_num" -gt 0 ]; then
                    local selected_host="${hosts[$((host_num-1))]}"
                    copy_key "$selected_host"
                else
                    echo "Invalid selection"
                    sleep 1
                fi
                ;;
            i|I)
                echo ""
                echo -n "Enter host number: "
                read -n 1 -s host_num
                echo ""
                if [ "$host_num" -le "${#hosts[@]}" ] && [ "$host_num" -gt 0 ]; then
                    local selected_host="${hosts[$((host_num-1))]}"
                    show_host_info "$selected_host"
                else
                    echo "Invalid selection"
                    sleep 1
                fi
                ;;
            r|R)
                continue
                ;;
            q|Q)
                echo "Goodbye!"
                exit 0
                ;;
            *)
                echo "Invalid option"
                sleep 1
                ;;
        esac
    done
}

# Run main function
main