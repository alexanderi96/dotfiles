#!/bin/bash

# Homelab Manager - Interactive SSH host management tool
# Reads from ~/.ssh/config and ~/.ssh/known_hosts

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Configuration
SSH_CONFIG="${HOME}/.ssh/config"
KNOWN_HOSTS="${HOME}/.ssh/known_hosts"

# Function to print colored output
print_color() {
    local color=$1
    shift
    echo -e "${color}$*${NC}"
}

# Function to print header
print_header() {
    clear
    print_color "$CYAN" "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    print_color "$CYAN" "‚ïë           ${BOLD}${WHITE}üè† Homelab Manager${NC}${CYAN}                          ‚ïë"
    print_color "$CYAN" "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo
}

# Function to extract hosts from SSH config
get_ssh_hosts() {
    if [ ! -f "$SSH_CONFIG" ]; then
        return
    fi
    
    grep -i "^Host " "$SSH_CONFIG" 2>/dev/null | \
        awk '{print $2}' | \
        grep -v "\*" | \
        sort -u
}

# Function to get host details from SSH config
get_host_details() {
    local host=$1
    local hostname=""
    local user=""
    local port="22"
    
    if [ ! -f "$SSH_CONFIG" ]; then
        echo "$host|$host|$USER|22"
        return
    fi
    
    # Parse SSH config for this host
    local in_host_block=0
    while IFS= read -r line; do
        if [[ $line =~ ^Host[[:space:]]+$host$ ]]; then
            in_host_block=1
            continue
        fi
        
        if [[ $in_host_block -eq 1 ]]; then
            if [[ $line =~ ^Host[[:space:]] ]]; then
                break
            fi
            
            if [[ $line =~ ^[[:space:]]*HostName[[:space:]]+(.+)$ ]]; then
                hostname="${BASH_REMATCH[1]}"
            elif [[ $line =~ ^[[:space:]]*User[[:space:]]+(.+)$ ]]; then
                user="${BASH_REMATCH[1]}"
            elif [[ $line =~ ^[[:space:]]*Port[[:space:]]+([0-9]+)$ ]]; then
                port="${BASH_REMATCH[1]}"
            fi
        fi
    done < "$SSH_CONFIG"
    
    [ -z "$hostname" ] && hostname="$host"
    [ -z "$user" ] && user="$USER"
    
    echo "$host|$hostname|$user|$port"
}

# Function to check if host is reachable
check_host_status() {
    local hostname=$1
    local port=$2
    
    if timeout 2 bash -c "cat < /dev/null > /dev/tcp/$hostname/$port" 2>/dev/null; then
        echo "online"
    else
        echo "offline"
    fi
}

# Function to display host status
display_hosts() {
    local hosts=()
    mapfile -t hosts < <(get_ssh_hosts)
    
    if [ ${#hosts[@]} -eq 0 ]; then
        print_color "$YELLOW" "‚ö†Ô∏è  No hosts found in $SSH_CONFIG"
        echo
        return 1
    fi
    
    print_color "$WHITE" "${BOLD}Host Status:${NC}"
    echo
    printf "%-4s %-20s %-25s %-15s %-10s\n" "No." "Host" "Hostname" "User" "Status"
    print_color "$CYAN" "$(printf '%.0s‚îÄ' {1..80})"
    
    local idx=1
    for host in "${hosts[@]}"; do
        IFS='|' read -r name hostname user port <<< "$(get_host_details "$host")"
        local status=$(check_host_status "$hostname" "$port")
        
        local status_color=$RED
        local status_icon="‚óè"
        if [ "$status" = "online" ]; then
            status_color=$GREEN
            status_icon="‚óè"
        fi
        
        printf "%-4s %-20s %-25s %-15s " "$idx" "$name" "$hostname" "$user"
        print_color "$status_color" "$status_icon $status"
        
        ((idx++))
    done
    
    echo
    return 0
}

# Function to connect to host
connect_host() {
    local host=$1
    print_color "$GREEN" "üîó Connecting to $host..."
    ssh "$host"
}

# Function to copy SSH key to host
copy_key() {
    local host=$1
    local key_file="${HOME}/.ssh/id_ed25519.pub"
    
    # Check for available keys
    if [ ! -f "$key_file" ]; then
        key_file="${HOME}/.ssh/id_rsa.pub"
    fi
    
    if [ ! -f "$key_file" ]; then
        print_color "$RED" "‚ùå No SSH public key found!"
        print_color "$YELLOW" "Generate one with: ssh-keygen -t ed25519"
        read -p "Press Enter to continue..."
        return
    fi
    
    print_color "$CYAN" "üìã Copying SSH key to $host..."
    if ssh-copy-id "$host" 2>/dev/null; then
        print_color "$GREEN" "‚úÖ SSH key copied successfully!"
    else
        print_color "$RED" "‚ùå Failed to copy SSH key"
    fi
    read -p "Press Enter to continue..."
}

# Function to show host info
show_host_info() {
    local host=$1
    IFS='|' read -r name hostname user port <<< "$(get_host_details "$host")"
    
    print_header
    print_color "$WHITE" "${BOLD}Host Information: $name${NC}"
    echo
    print_color "$CYAN" "Hostname:  ${WHITE}$hostname"
    print_color "$CYAN" "User:      ${WHITE}$user"
    print_color "$CYAN" "Port:      ${WHITE}$port"
    echo
    
    local status=$(check_host_status "$hostname" "$port")
    if [ "$status" = "online" ]; then
        print_color "$GREEN" "Status:    ‚óè Online"
    else
        print_color "$RED" "Status:    ‚óè Offline"
    fi
    
    echo
    read -p "Press Enter to continue..."
}

# Function to display menu
show_menu() {
    local hosts=()
    mapfile -t hosts < <(get_ssh_hosts)
    
    echo
    print_color "$WHITE" "${BOLD}Actions:${NC}"
    echo
    echo "  1-${#hosts[@]})  Connect to host"
    echo "  c)  Copy SSH key to host"
    echo "  i)  Show host info"
    echo "  r)  Refresh status"
    echo "  q)  Quit"
    echo
}

# Main interactive loop
main() {
    while true; do
        print_header
        
        if ! display_hosts; then
            print_color "$YELLOW" "Create hosts in $SSH_CONFIG"
            echo
            print_color "$CYAN" "Example:"
            echo "Host myserver"
            echo "    HostName 192.168.1.100"
            echo "    User admin"
            echo "    Port 22"
            echo
            read -p "Press Enter to exit..."
            exit 0
        fi
        
        show_menu
        
        read -p "$(print_color $MAGENTA 'Select option: ')" choice
        
        local hosts=()
        mapfile -t hosts < <(get_ssh_hosts)
        
        case $choice in
            [1-9]|[1-9][0-9])
                if [ "$choice" -le "${#hosts[@]}" ] && [ "$choice" -gt 0 ]; then
                    local selected_host="${hosts[$((choice-1))]}"
                    connect_host "$selected_host"
                else
                    print_color "$RED" "Invalid selection"
                    sleep 1
                fi
                ;;
            c|C)
                echo
                read -p "Enter host number: " host_num
                if [ "$host_num" -le "${#hosts[@]}" ] && [ "$host_num" -gt 0 ]; then
                    local selected_host="${hosts[$((host_num-1))]}"
                    copy_key "$selected_host"
                else
                    print_color "$RED" "Invalid selection"
                    sleep 1
                fi
                ;;
            i|I)
                echo
                read -p "Enter host number: " host_num
                if [ "$host_num" -le "${#hosts[@]}" ] && [ "$host_num" -gt 0 ]; then
                    local selected_host="${hosts[$((host_num-1))]}"
                    show_host_info "$selected_host"
                else
                    print_color "$RED" "Invalid selection"
                    sleep 1
                fi
                ;;
            r|R)
                continue
                ;;
            q|Q)
                print_color "$GREEN" "üëã Goodbye!"
                exit 0
                ;;
            *)
                print_color "$RED" "Invalid option"
                sleep 1
                ;;
        esac
    done
}

# Run main function
main